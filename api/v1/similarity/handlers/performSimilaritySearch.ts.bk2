import { Request, Response, NextFunction } from "express";
import * as fs from "fs";

import { HNSWLib } from "langchain/vectorstores/hnswlib";

import { OpenAIEmbeddings } from "langchain/embeddings/openai";
import { RecursiveCharacterTextSplitter } from "langchain/text_splitter";

import { ChromaClient } from "chromadb";

import { OpenAIEmbeddingFunction } from "chromadb";
const embedder = new OpenAIEmbeddingFunction({
  openai_api_key: process.env.OPENAI_API_KEY!,
});

const client = new ChromaClient();

export async function performSimilaritySearch(
  req: Request,
  res: Response,
  next: NextFunction
) {
  try {
    const query = req.body.query;

    console.log("query", query);

    const text = fs.readFileSync(`${req.file?.path}`, "utf8");

    // const splitter = new RecursiveCharacterTextSplitter({
    //   separators: ["\n\n", "\n", "."],
    // });
    // const output = await splitter.createDocuments([text]);

    // const re = RegExp("(?<!w.w.)(?<![A-Z][a-z].)(?<=.|?)s");
    // const matches = text.match(re);
    // console.log("matches", matches);

    let intResults = text.match(/[^\.!\?]+[\.!\?]+/g);

    console.log("intResults", intResults);

    let chunks = intResults?.map((i, idx) => {
      //   console.log("i", i.pageContent);

      return i.pageContent;
    });
    // let metadata = output.map((i, idx) => {
    //   console.log("i", i.metadata);

    //   return i.metadata;
    // });
    // let ids = output.map((i, idx) => {
    //   console.log("i", i.metadata);

    //   return `id${idx}`;
    // });

    try {
      await client.deleteCollection({
        name: "test_collection",
      });
    } catch (e) {}

    const test_collection = await client.createCollection({
      name: "test_collection",
      embeddingFunction: embedder,
    });

    // await test_collection.add({
    //   ids: ids,
    //   metadatas: metadata,
    //   documents: chunks,
    // });

    // const results = await test_collection.query({
    //   nResults: 1,
    //   queryTexts: [query],
    // });

    // const vectorStore = await HNSWLib.fromTexts(
    //   chunks,
    //   metadata,
    //   new OpenAIEmbeddings()
    // );

    // const vectorStore = await FaissStore.fromTexts(
    //   chunks,
    //   metadata,
    //   new OpenAIEmbeddings()
    // );

    // const results = await vectorStore.similaritySearchWithScore(query);

    console.log("___ --- ___ --- ___");

    try {
      await client.deleteCollection({
        name: "test_collection",
      });
    } catch (e) {}

    // console.log(results);
    // res.status(200).send();

    res.status(200).json({
      results: results,
    });
  } catch (e) {
    next(e);
  }
}

// const resp = completion.data?.choices[0]?.message?.content;
// gpt-3.5-turbo $0.002 / 1K tokens
// gpt-3.5-turbo 90,000 TPM
// gpt-3.5-turbo token limit per request is 4096 tokens
// 2171 / 1000 = 2.1 x 0.002 = $0.004?
